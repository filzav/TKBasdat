CREATE SCHEMA SIASISTEN;

SET SEARCH_PATH TO SIASISTEN;

CREATE DOMAIN ID AS INTEGER;

CREATE TABLE MATA_KULIAH(
	Kode CHAR(10) PRIMARY KEY,
	Nama VARCHAR(100) NOT NULL,
	Prasyarat CHAR(10) REFERENCES MATA_KULIAH(Kode) ON UPDATE CASCADE ON DELETE SET NULL
);

CREATE TABLE TERM(
	Tahun INTEGER,
	Semester INTEGER,
	PRIMARY KEY(Tahun, Semester)
);

CREATE TABLE KELAS_MK(
	IDKelasMK ID PRIMARY KEY,
	Tahun INTEGER NOT NULL,
	Semester INTEGER NOT NULL, 
	FOREIGN KEY(Tahun, Semester) REFERENCES TERM(Tahun, Semester) ON UPDATE CASCADE ON DELETE RESTRICT,
	Kode_MK CHAR(10) NOT NULL REFERENCES MATA_KULIAH(Kode) ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE DOSEN(
	NIP VARCHAR(20) PRIMARY KEY,
	Nama VARCHAR(100) NOT NULL,
	Username VARCHAR(30) NOT NULL,
	Password VARCHAR(20) NOT NULL,
	Email VARCHAR(100) NOT NULL,
	Universitas VARCHAR(100) NOT NULL,
	Fakultas VARCHAR(100) NOT NULL
);

CREATE TABLE MAHASISWA(
	NPM CHAR(10) PRIMARY KEY,
	Nama VARCHAR(100) NOT NULL,
	Username VARCHAR(30) NOT NULL,
	Password VARCHAR(20) NOT NULL,
	Email VARCHAR(100) NOT NULL,
	Email_aktif VARCHAR(100),
	Waktu_kosong VARCHAR(100),
	Bank VARCHAR(100),
	Norekening VARCHAR(100),
	Url_mukatab VARCHAR(100),
	Url_foto VARCHAR(100)
);

CREATE TABLE TELEPON_MAHASISWA(
	NPM CHAR(10) REFERENCES MAHASISWA(NPM) ON UPDATE CASCADE ON DELETE CASCADE,
	Nomortelepon VARCHAR(20) NOT NULL,
	PRIMARY KEY (NPM, Nomortelepon)
);

CREATE TABLE MHS_MENGAMBIL_KELAS_MK(
	NPM CHAR(10) REFERENCES MAHASISWA(NPM) ON UPDATE CASCADE ON DELETE CASCADE,
	IDKelasMK ID REFERENCES KELAS_MK(IDKelasMK) ON UPDATE CASCADE ON DELETE CASCADE,
	Nilai NUMERIC(5,2),
	PRIMARY KEY(NPM, IDKelasMK)
);

CREATE TABLE DOSEN_KELAS_MK(
	NIP VARCHAR(20) REFERENCES DOSEN(NIP) ON UPDATE CASCADE ON DELETE CASCADE,
	IDKelasMK ID REFERENCES KELAS_MK(IDKelasMK) ON UPDATE CASCADE ON DELETE CASCADE,
	PRIMARY KEY(NIP, IDKelasMK)
);

CREATE TABLE LOWONGAN(
	IDLowongan ID PRIMARY KEY,
	IDKelasMK ID NOT NULL REFERENCES KELAS_MK ON UPDATE CASCADE ON DELETE CASCADE,
	Status BOOLEAN NOT NULL DEFAULT False,
	Jumlah_asisten INTEGER NOT NULL DEFAULT 0,
	Syarat_tambahan VARCHAR(100),
	NIPDosenPembuka VARCHAR(20) NOT NULL REFERENCES DOSEN(NIP) ON UPDATE CASCADE ON DELETE RESTRICT,
	jumlah_pelamar INTEGER DEFAULT 0,
	jumlah_pelamar_diterima INTEGER DEFAULT 0
);

CREATE TABLE STATUS_LAMARAN(
	ID ID PRIMARY KEY,
	Status VARCHAR(20) NOT NULL
);

CREATE TABLE LAMARAN(
	IDLamaran ID,
	NPM CHAR(10) REFERENCES MAHASISWA(NPM) ON UPDATE CASCADE ON DELETE SET NULL,
	IDLowongan ID NOT NULL REFERENCES LOWONGAN(IDLowongan) ON UPDATE CASCADE ON DELETE CASCADE,
	ID_st_lamaran ID NOT NULL REFERENCES STATUS_LAMARAN(ID) ON UPDATE CASCADE ON DELETE RESTRICT,
	IPK NUMERIC(5,2) NOT NULL,
	JumlahSKS INTEGER NOT NULL,
	NIP VARCHAR(20) REFERENCES DOSEN(NIP) ON UPDATE CASCADE ON DELETE SET NULL,
	PRIMARY KEY(IDLamaran, NPM)
);

CREATE TABLE STATUS_LOG(
	ID ID PRIMARY KEY,
	Status VARCHAR(10) NOT NULL
);

CREATE TABLE KATEGORI_LOG(
	ID ID PRIMARY KEY,
	Kategori VARCHAR(50) NOT NULL
);

CREATE TABLE LOG(
	IDLog ID PRIMARY KEY,
	IDLamaran ID NOT NULL,
	NPM CHAR(10) NOT NULL,
	FOREIGN KEY(IDLamaran, NPM) REFERENCES LAMARAN(IDLamaran, NPM) ON UPDATE CASCADE ON DELETE CASCADE,
	ID_kat_log ID NOT NULL REFERENCES KATEGORI_LOG(ID) ON UPDATE CASCADE ON DELETE RESTRICT,
	ID_st_log ID NOT NULL REFERENCES STATUS_LOG(ID) ON UPDATE CASCADE ON DELETE RESTRICT,
	Tanggal TIMESTAMP NOT NULL,
	Jam_mulai TIMESTAMP NOT NULL,
	Jam_selesai TIMESTAMP NOT NULL,
	Deskripsi_kerja VARCHAR(100) NOT NULL
);